# .github/workflows/release-manager.yml
name: 'ğŸš€ Release Manager'

on:
  push:
    branches:
      - main
  pull_request: # for autolabeler
    types:
      - opened
      - reopened
      - synchronize

  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish the draft as an official release?'
        type: boolean
        required: true
        default: false
      prerelease-identifier:
        description: |
          A string indicating an identifier (alpha, beta, rc, etc), to increment the prerelease version.
        required: false
        default: ''

  repository_dispatch:
    types: [upstream-updated]

permissions:
  contents: read

jobs:
  draft-or-publish:
    permissions:
      contents: write
      pull-requests: write  # write for autolabeler, otherwise read
    runs-on: ubuntu-latest
    steps:
      # 1. å¿…é¡»æ£€å‡ºä»£ç æ‰èƒ½è¯»å– package.json
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: 'Determine release parameters'
        id: params
        shell: bash
        run: |
          PUBLISH=false
          PRERELEASE=false
          PRERELEASE_ID=""
          
          echo "ğŸ“‹ Event: ${{ github.event_name }}"
          
          case "${{ github.event_name }}" in
            workflow_dispatch)
              if [[ "${{ inputs.publish }}" == "true" ]]; then
                PUBLISH=true
                echo "   âœ“ Will publish release"
                
                if [[ -n "${{ inputs.prerelease-identifier }}" ]]; then
                  PRERELEASE=true
                  PRERELEASE_ID="${{ inputs.prerelease-identifier }}"
                  echo "   âœ“ Prerelease: $PRERELEASE_ID"
                fi
              fi
              ;;
            
            repository_dispatch)
              TRIGGERED_BY="${{ github.event.client_payload.triggered_by }}"
              echo "   Repository dispatch from: $TRIGGERED_BY"
              if [[ "$TRIGGERED_BY" == "upstream-watcher" ]]; then
                PUBLISH=true
                echo "   âœ“ Upstream update detected, will publish release"
              fi
              ;;
            *)
              echo "   Standard event, updating draft only"
              ;;
          esac
          
          {
            echo "publish=$PUBLISH"
            echo "prerelease=$PRERELEASE"
            echo "prerelease_id=$PRERELEASE_ID"
          } >> "$GITHUB_OUTPUT"

      # 2. æ ¸å¿ƒæ­¥éª¤ï¼šç”Ÿæˆæ—¥æœŸç‰ˆæœ¬å· + æå–å­åŒ…ç‰ˆæœ¬
      - name: 'Prepare Release Info'
        id: info
        shell: bash
        run: |
          # ç”Ÿæˆæ—¥æœŸ Tag (ä¾‹å¦‚: 2024.01.05.1430)
          DATE_TAG=$(TZ='America/Los_Angeles' date +'%Y.%m.%d.%H%M')
          echo "ğŸ”¹ Generated Tag: $DATE_TAG"
          
          # ä½¿ç”¨ jq æå– package.json ä¸­çš„ç‰ˆæœ¬å·
          V_ULTRA=$(jq -r .version packages/ultra/package.json)
          V_SVELTE=$(jq -r .version packages/svelte/package.json)
          V_CLI=$(jq -r .version packages/cli/package.json)
          
          # æ„å»º Markdown è¡¨æ ¼
          VERSION_TABLE="### ğŸ“¦ Core Packages Versions
          | Package | Version |
          | :--- | :--- |
          | **ultra** | \`v$V_ULTRA\` |
          | **svelte** | \`v$V_SVELTE\` |
          | **cli** | \`v$V_CLI\` |
          "
          
          # å¤„ç†å¤šè¡Œæ–‡æœ¬è¾“å‡ºåˆ° GITHUB_OUTPUT
          echo "date_tag=$DATE_TAG" >> $GITHUB_OUTPUT
          
          echo "versions<<EOF" >> $GITHUB_OUTPUT
          echo "$VERSION_TABLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 3. è¿è¡Œ Release Drafter
      - name: 'Run Release Draft'
        uses: release-drafter/release-drafter@b1476f6e6eb133afa41ed8589daba6dc69b4d3f5  # v6.1.0
        with:
          # https://github.com/release-drafter/release-drafter/issues/1125
          commitish: ${{ github.event.repository.default_branch }}
          
          # åŠ¨æ€æ§åˆ¶å‘å¸ƒçŠ¶æ€
          publish: ${{ steps.params.outputs.publish }}
          prerelease: ${{ steps.params.outputs.prerelease }}
          prerelease-identifier: ${{ steps.params.outputs.prerelease_id }}
          
          # ã€å…³é”®ã€‘å¼ºåˆ¶ä½¿ç”¨æ—¥æœŸä½œä¸º Tag å’Œæ ‡é¢˜ï¼Œè¦†ç›–è‡ªåŠ¨è¯­ä¹‰åŒ–è®¡ç®—
          tag: ${{ steps.info.outputs.date_tag }}
          name: "ğŸš€ Release ${{ steps.info.outputs.date_tag }}"
          
          # ã€å…³é”®ã€‘å°†åŒ…ç‰ˆæœ¬è¡¨æ ¼æ³¨å…¥åˆ° Release Body çš„å¤´éƒ¨
          header: ${{ steps.info.outputs.versions }}
          
        env:
          # GITHUB_TOKEN cannot trigger a new workflow.
          GITHUB_TOKEN: ${{ steps.params.outputs.publish == 'true' && secrets.BOT_PAT || secrets.GITHUB_TOKEN }}

