name: Upstream Sync Check

on:
  schedule:
    # Check every Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          fetch-depth: 0
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2.1.0
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/hunvreus/basecoat.git
          git fetch upstream --tags
          
          # Create tracking branch if not exists
          git branch upstream/tracking upstream/main 2>/dev/null || \
            git branch -f upstream/tracking upstream/main
      
      - name: Check for updates
        id: check
        run: |
          # Get current tracking commit (from last sync)
          TRACKING_COMMIT=$(git rev-parse upstream/tracking 2>/dev/null || echo "")
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          
          if [ -z "$TRACKING_COMMIT" ]; then
            echo "First run, setting baseline"
            NEW_COMMITS=0
          else
            NEW_COMMITS=$(git rev-list --count ${TRACKING_COMMIT}..${UPSTREAM_COMMIT} 2>/dev/null || echo "0")
          fi
          
          echo "new_commits=$NEW_COMMITS" >> $GITHUB_OUTPUT
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          
          # Get upstream version tag
          UPSTREAM_TAG=$(git describe --tags --exact-match upstream/main 2>/dev/null || \
                         git describe --tags --always upstream/main)
          echo "upstream_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          
          if [ "$NEW_COMMITS" -gt "0" ]; then
            echo "Found $NEW_COMMITS new commit(s)"
            git log --oneline ${TRACKING_COMMIT}..${UPSTREAM_COMMIT} > upstream-changes.txt
            
            # Run diff analysis from packages/ultra
            cd packages/ultra
            bun run upstream:diff || true
          fi
      
      - name: Upload analysis artifacts
        if: steps.check.outputs.new_commits > 0
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: upstream-analysis
          path: |
            packages/ultra/upstream-analysis/UPSTREAM_DIFF.md
            packages/ultra/upstream-analysis/patches/
            packages/ultra/upstream-analysis/latest-analysis.json
          retention-days: 30
      
      - name: Create Issue if updates found
        if: steps.check.outputs.new_commits > 0
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            const fs = require('fs');
            
            let changes = '';
            try {
              changes = fs.readFileSync('upstream-changes.txt', 'utf8');
            } catch (e) {
              changes = 'Could not read changes';
            }
            
            let diffReport = '';
            try {
              diffReport = fs.readFileSync('packages/ultra/upstream-analysis/UPSTREAM_DIFF.md', 'utf8');
              // Truncate if too long
              if (diffReport.length > 50000) {
                diffReport = diffReport.substring(0, 50000) + '\n\n... (truncated)';
              }
            } catch (e) {
              diffReport = 'Diff report not available';
            }
            
            const newCommits = '${{ steps.check.outputs.new_commits }}';
            const upstreamTag = '${{ steps.check.outputs.upstream_tag }}';
            
            // Check for existing open issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'upstream-sync',
              state: 'open'
            });
            
            if (existingIssues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `## Update: ${new Date().toISOString()}\n\nUpstream now at **${upstreamTag}** with ${newCommits} new commit(s).\n\n### New Commits:\n\`\`\`\n${changes}\n\`\`\`\n\n<details>\n<summary>Full Diff Report</summary>\n\n${diffReport}\n\n</details>`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”„ Upstream Basecoat updated to ${upstreamTag}`,
                body: `## Upstream Repository Update\n\nThe upstream [basecoat](https://github.com/hunvreus/basecoat) repository has **${newCommits}** new commit(s).\n\n### Version\n- **Tag**: ${upstreamTag}\n- **Commit**: ${{ steps.check.outputs.upstream_commit }}\n\n### New Commits\n\`\`\`\n${changes}\n\`\`\`\n\n### Diff Analysis\n\n<details>\n<summary>Click to expand full diff report</summary>\n\n${diffReport}\n\n</details>\n\n### Next Steps\n\n1. Download the analysis artifacts from this workflow run\n2. Review the patches in \`upstream-analysis/patches/\`\n3. Run locally:\n   \`\`\`bash\n   bun run upstream:sync\n   bun run upstream:diff\n   \`\`\`\n4. Cherry-pick or manually apply relevant changes\n5. Update \`UPSTREAM.md\` with sync status\n6. Close this issue when done`,
                labels: ['upstream-sync']
              });
            }
